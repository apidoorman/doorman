name: doorman-demo
version: '3.8'

services:
  doorman:
    # Reuse the same build but inject demo-friendly frontend URL
    build:
      context: .
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_GATEWAY_URL: http://localhost:3001
        NEXT_PUBLIC_PROTECTED_USERS: demo@doorman.dev
    image: doorman-demo:latest
    container_name: null
    environment:
      # App mode
      ENV: development
      MEM_OR_EXTERNAL: MEM
      THREADS: 1
      HTTPS_ONLY: "false"

      # Admin bootstrap
      DOORMAN_ADMIN_EMAIL: demo@doorman.dev
      DOORMAN_ADMIN_PASSWORD: DemoPassword123!
      JWT_SECRET_KEY: demo-secret-change-me-please-32-bytes-min

      # Demo seeding
      DEMO_SEED: "true"

      # Ports (compose defaults already match these)
      PORT: 3001
      WEB_PORT: 3000

    # Tip: use a different host port if you already run something on 3000/3001
    ports:
      - "3001:3001"
      - "3000:3000"

    # Ensure it doesn't restart and doesn't persist bind mounts from base compose
    restart: "no"
    volumes: []

  demo-cleanup:
    image: docker:27.3.1-cli
    container_name: doorman-demo-cleanup
    restart: "no"
    # Wait idly; on SIGTERM/INT (when you Ctrl+C compose), run cleanup
    command: ["/bin/sh", "-c", "trap '/bin/sh /cleanup.sh' TERM INT; tail -f /dev/null"]
    environment:
      - PROJECT=doorman-demo
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./docker/cleanup.sh:/cleanup.sh:ro
    depends_on:
      - doorman
