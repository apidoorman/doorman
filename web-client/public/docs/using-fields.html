<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Doorman Field Guide</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Noto Sans",sans-serif;line-height:1.5;margin:0;padding:0;color:#1f2937;background:#fff}
    header{background:#111827;color:#e5e7eb;padding:16px 24px}
    main{max-width:920px;margin:24px auto;padding:0 16px}
    h1{font-size:24px;margin:0}
    h2{margin-top:28px;border-bottom:1px solid #e5e7eb;padding-bottom:6px}
    h3{margin-top:20px}
    code{background:#f3f4f6;padding:2px 4px;border-radius:4px}
    pre{background:#0b1020;color:#e5e7eb;padding:12px;border-radius:8px;overflow:auto}
    .tip{background:#ecfeff;border:1px solid #a5f3fc;color:#155e75;padding:10px;border-radius:8px}
    .warn{background:#fef3c7;border:1px solid #fde68a;color:#7c2d12;padding:10px;border-radius:8px}
    a{color:#2563eb}
    ul{margin-left:20px}
  </style>
  </head>
<body>
  <header><h1>Doorman Field Guide</h1></header>
  <main>
    <p>This guide explains sensitive fields and common configurations with examples.</p>

    <h2 id="production">Production Hardening</h2>
    <ul>
      <li><strong>ENV=production</strong>: enables stricter security validations at startup.</li>
      <li><strong>HTTPS_ONLY=true</strong>: forces Secure cookies and HTTPS checks (use a TLS terminator in front).</li>
      <li><strong>JWT_SECRET_KEY</strong>: required; 32+ random bytes. Rotate regularly.</li>
      <li><strong>TOKEN_ENCRYPTION_KEY</strong>: 32+ bytes to encrypt API keys at rest.</li>
      <li><strong>MEM_ENCRYPTION_KEY</strong>: 32+ bytes (required in MEM mode) to protect memory dumps.</li>
      <li><strong>COOKIE_SAMESITE=Strict</strong> and set <strong>COOKIE_DOMAIN</strong> appropriately for your hostname.</li>
      <li><strong>LOCAL_HOST_IP_BYPASS=false</strong>: disable localhost bypass in production.</li>
      <li><strong>CORS</strong>: avoid wildcard origins when credentials are used; prefer explicit origins or set <strong>CORS_STRICT=true</strong>.</li>
      <li><strong>Secrets</strong>: do not commit real secrets; use a vault/CI secrets store and environment injection.</li>
    </ul>

    <h2 id="apis">APIs</h2>
    <p><strong>API Name/Version</strong> define the base path clients call: <code>/api/rest/&lt;name&gt;/&lt;version&gt;/...</code>.</p>
    <div class="tip">Example: name <code>users</code>, version <code>v1</code> → client calls <code>/api/rest/users/v1/list</code></div>

    <h3 id="api-config">Configuration</h3>
    <ul>
      <li><strong>Credits Enabled</strong>: deducts credits before proxying; configure a <em>Credit Group</em> that injects an API key header.</li>
      <li><strong>Authorization Field Swap</strong>: maps inbound <code>Authorization</code> into a custom upstream header (e.g., <code>X-Api-Key</code>).</li>
      <li><strong>Allowed Headers</strong>: restrict which upstream <em>response</em> headers are forwarded back (use lowercase names). See Headers &amp; Forwarding below.</li>
    </ul>
    <pre>
# Example curl
curl -H "Authorization: Bearer ..." \
     http://localhost:3001/api/rest/users/v1/list
    </pre>

    <h3 id="servers">Servers</h3>
    <p>Add one or more upstream base URLs (scheme + host + port). Endpoint-level servers can override. Selection defaults to round-robin.</p>

    <h3 id="access-control">Access Control</h3>
    <p>Access requires BOTH an allowed <em>role</em> and membership in ANY allowed <em>group</em>.</p>

    <h2 id="endpoints">Endpoints</h2>
    <p>Define <strong>Method</strong> and <strong>URI</strong> relative to the API base. Use <code>{param}</code> syntax for path variables.</p>
    <div class="tip">Example: <code>GET /items/{id}</code> matches <code>/api/rest/users/v1/items/123</code></div>
    <p>Enable <strong>Endpoint Servers</strong> to override API servers for this endpoint only.</p>

    <h2 id="routing">Routing</h2>
    <p>Create named routing sets with an ordered list of upstreams. Doorman may choose an upstream based on client key, method, and policies.</p>

    <h2 id="headers">Headers &amp; Forwarding</h2>
    <p>
      Doorman forwards a conservative subset of <em>request</em> headers to upstreams and a configurable subset of
      <em>response</em> headers back to clients.
    </p>
    <h3>Sensitive headers (never forwarded by allow‑list)</h3>
    <ul>
      <li><code>authorization</code> (Bearer/Basic/etc); use <strong>Authorization Field Swap</strong> to map into a custom upstream header</li>
      <li><code>cookie</code>, <code>set-cookie</code></li>
      <li>Common API key names (e.g., <code>x-api-key</code>, <code>api-key</code>)</li>
      <li><code>x-csrf-token</code></li>
    </ul>
    <p class="tip">Even if you list a sensitive header under <strong>Allowed Headers</strong>, it is not forwarded by the allow‑list.
      To send credentials upstream, configure <strong>Authorization Field Swap</strong> or use Credit Groups (which inject a safe API key header).</p>

    <h3>SOAP defaults</h3>
    <p>
      For SOAP APIs, Doorman automatically allows common <em>request</em> headers to make onboarding easier:
      <code>Content-Type</code>, <code>SOAPAction</code>, <code>Accept</code>, <code>User-Agent</code>, <code>Accept-Encoding</code>.
      You do not need to add these to the allow‑list.
    </p>
    <p>
      Response headers for SOAP remain governed by your APIs <strong>Allowed Headers</strong> list (only those will be forwarded back).
    </p>

    <h3>Per‑API behavior</h3>
    <ul>
      <li><strong>Request headers → upstream</strong>: REST/GraphQL/gRPC forward only headers listed in <strong>Allowed Headers</strong> (minus sensitive headers). SOAP also includes the defaults above.</li>
      <li><strong>Response headers → client</strong>: Only headers listed in <strong>Allowed Headers</strong> are forwarded back for all protocols.</li>
      <li><strong>CORS</strong>: Controlled per‑API; preflight/response headers are computed from API CORS fields.</li>
    </ul>

    <h2 id="users">Users</h2>
    <ul>
      <li><strong>Password</strong>: minimum 16 chars with upper/lower/digit/symbol.</li>
      <li><strong>Role</strong>: determines platform permissions (e.g., manage_apis, view_logs).</li>
      <li><strong>UI Access</strong>: controls login to admin UI; API access is independent.</li>
      <li><strong>Groups</strong>: used in API group checks (see Access Control).</li>
    </ul>

    <h3 id="rate-limit">Rate Limiting</h3>
    <p>Limits requests per user over a time window (e.g., 100 per minute). Exceeding limits returns 429.</p>

    <h3 id="throttle">Throttling</h3>
    <p>Controls burst behavior with <em>duration</em>, <em>wait</em>, and optional <em>queue size</em>.</p>
    <ul>
      <li><strong>Throttle Duration</strong>: period length before reset.</li>
      <li><strong>Wait Duration</strong>: how long requests wait when throttled before retry.</li>
      <li><strong>Queue Limit</strong>: max queued requests; null disables queuing.</li>
    </ul>

    <h2 id="credits">Credits</h2>
    <p>Credit definitions specify a <strong>credit group</strong>, an API key header name, a default API key value, and one or more tiers.</p>
    <ul>
      <li><strong>API Credit Group</strong>: reference name used by APIs to deduct credits and inject keys.</li>
      <li><strong>API Key Header</strong>: header name injected when proxying (e.g., <code>x-api-key</code>).</li>
      <li><strong>API Key</strong>: default key used when proxying; users can also have per-user keys.</li>
      <li><strong>Tiers</strong>: JSON array with <code>tier_name</code>, <code>credits</code>, <code>input_limit</code>, <code>output_limit</code>, and <code>reset_frequency</code>.</li>
    </ul>

    <h2 id="security">Security</h2>
    <p><strong>Auto-save</strong> writes encrypted memory dumps periodically (requires <code>MEM_ENCRYPTION_KEY</code>). <strong>Dump Path</strong> stores the file; use an encrypted volume.
    <div class="warn">Restart is required to apply server TLS changes when running with built-in HTTPS. Use an edge proxy for zero-downtime rotation.</div>

    <h2 id="auth-admin">Auth Admin</h2>
    <p>Check status, revoke tokens, and enable/disable users. Revocation immediately invalidates tokens; enable/disable toggles login capability.</p>

    <h2 id="examples">Examples</h2>
    <pre>
# REST call through Doorman
curl -H "Authorization: Bearer &lt;token&gt;" \
     -H "client-key: demo-client" \
     http://localhost:3001/api/rest/users/v1/items/42

# GraphQL
curl -H "Authorization: Bearer &lt;token&gt;" \
     -H "X-API-Version: v1" \
     -H "Content-Type: application/json" \
     -d '{"query":"{ hello }"}' \
     http://localhost:3001/api/graphql/example
    </pre>
  </main>
</body>
</html>
